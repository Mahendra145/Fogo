<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fogo Admin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f0f1a;
      color: #fff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header { background: #ff5722; padding: 1rem; font-size: 1.5rem; font-weight: bold; }
    .container { max-width: 700px; margin: 2rem auto; padding: 1rem; }
    .card { background: #1e1e30; margin: 1rem 0; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.4); text-align: left; }
    input, select, button { display: block; width: 100%; box-sizing: border-box; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none; font-size: 1rem; }
    button { cursor: pointer; font-weight: bold; }
    .btn-admin { background: #ff5722; color: white; }
    .btn-delete { background: #d32f2f; color: white; padding: 4px 8px; margin-left: 10px; border-radius: 3px; display: inline-block; width: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #333; }
    h3 { text-align: center; margin-top: 0; }
    .task-entry { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .task-entry:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <header>Fogo Admin Panel</header>
  <div class="container">

    <div class="card">
      <h3>Enter Admin Key</h3>
      <input id="adminKey" type="password" placeholder="Admin Key" />
      <button id="loginAdmin" class="btn-admin">Unlock</button>
    </div>

    <div id="taskManager" class="card" style="display:none;">
      <h3>Create New Task</h3>
      <input id="taskName" placeholder="Task Name (e.g., 'Like our latest post')" />
      <select id="taskType">
        <option value="social.like">X: Like</option>
        <option value="social.retweet">X: Retweet</option>
        <option value="social.reply">X: Reply</option>
        <option value="special">Follow (Special)</option>
        <option value="link.task">Link Task (Instant Claim)</option>
      </select>
      <input id="taskPoints" placeholder="Points" type="number" value="100" />
      <input id="taskHref" placeholder="Task URL (e.g., Tweet or Profile Link)" />
      <button id="createTask" class="btn-admin">Create Task</button>
    </div>

    <div id="tasks" class="card" style="display:none;">
      <h3>Current Tasks</h3>
      <div id="taskList"></div>
    </div>

    <div id="leaderboard" class="card" style="display:none;">
      <h3>Leaderboard</h3>
      <div id="lbContent"></div>
    </div>

  </div>

  <script>
    const API_BASE = "";
    let ADMIN_KEY = null;

    function extractTweetId(url) {
      const match = url.match(/status\/(\d+)/);
      return match ? match[1] : null;
    }

    function extractUsername(url) {
      const match = url.match(/(?:twitter|x)\.com\/([a-zA-Z0-9_]+)/);
      return match ? match[1] : null;
    }

    async function api(path, opts={}) {
      try {
        const res = await fetch(API_BASE + path, {
          headers: { "Content-Type":"application/json", "x-admin-key": ADMIN_KEY || "" },
          ...opts
        });
        if(!res.ok) {
            const errorData = await res.json();
            throw new Error(`HTTP ${res.status}: ${errorData.error || 'Unknown error'}`);
        }
        return await res.json();
      } catch(err) {
        console.error("API Error:", err);
        alert(`API Error: ${err.message}`);
        return null;
      }
    }

    async function fetchUserIdFromUsername(username) {
      const res = await api(`/api/admin/resolve-username?username=${username}`);
      if (res && res.id) return res.id;
      throw new Error("Could not resolve username: " + username);
    }

    document.getElementById("loginAdmin").onclick = () => {
      ADMIN_KEY = document.getElementById("adminKey").value.trim();
      if (!ADMIN_KEY) return alert("Enter the Admin Key");
      document.getElementById("loginAdmin").parentElement.style.display = 'none';
      document.getElementById("taskManager").style.display="block";
      document.getElementById("tasks").style.display="block";
      document.getElementById("leaderboard").style.display="block";
      loadTasks();
      loadLeaderboard();
    };

    document.getElementById("createTask").onclick = async () => {
      const typeSelect = document.getElementById("taskType").value;
      const taskHref = document.getElementById("taskHref").value.trim();
      
      // REVERTED: Kept your original logic for handling the "special" task type
      let taskType = typeSelect;
      if (typeSelect === "special") {
        taskType = "social.follow";
      }

      const payload = {
        name: document.getElementById("taskName").value.trim(),
        type: taskType,
        points: Number(document.getElementById("taskPoints").value),
        href: taskHref
      };

      if (!payload.name || !payload.href || !payload.points) {
          return alert("Please fill in all task fields.");
      }
      
      try {
        if (taskType === "social.like" || taskType === "social.retweet" || taskType === "social.reply") {
          payload.tweet_id = extractTweetId(taskHref);
          if (!payload.tweet_id) return alert("Invalid Tweet URL provided.");
        } else if (taskType === "social.follow") {
          const username = extractUsername(taskHref);
          if (!username) return alert("Invalid Profile URL provided.");
          payload.target_user_id = await fetchUserIdFromUsername(username);
        }

        const res = await api("/api/admin/tasks", { method:"POST", body: JSON.stringify(payload) });
        if(res && res.task){
          alert("Task created successfully!");
          document.getElementById("taskName").value="";
          document.getElementById("taskHref").value="";
          loadTasks();
        }
      } catch (err) {
        alert(`Failed to create task: ${err.message}`);
      }
    };

    async function loadTasks() {
      // FIXED: API path updated to make the function work
      const list = await api("/api/fogo/tasks");
      const div = document.getElementById("taskList");
      div.innerHTML = "";
      if(Array.isArray(list)){
        if (list.length === 0) {
            div.innerHTML = "<p style='text-align: center; color: #9ca3af;'>No tasks created yet.</p>";
            return;
        }
        list.forEach(t => {
          const el = document.createElement("div");
          el.className = 'task-entry';
          el.innerHTML = `
            <span><b>${t.name}</b> (${t.type}) â€¢ ${t.points} pts</span>
            <span>
              ${t.href ? `<a href="${t.href}" target="_blank">Link</a>` : ""}
              <button class="btn-delete" onclick="deleteTask(${t.id})">Delete</button>
            </span>`;
          div.appendChild(el);
        });
      } else {
        div.innerHTML = "<p>Error loading tasks.</p>";
      }
    }

    async function deleteTask(id){
      if(!confirm("Are you sure you want to delete this task?")) return;
      const res = await api("/api/admin/tasks/" + id, { method:"DELETE" });
      if(res && res.message) { 
          alert("Task deleted!"); 
          loadTasks(); 
      }
    }

    async function loadLeaderboard() {
      // FIXED: API path updated to make the function work
      const data = await api("/api/fogo/leaderboard");
      const div = document.getElementById("lbContent");
      if(Array.isArray(data)){
        let html = "<table><tr><th>User</th><th>Points</th></tr>";
        data.forEach(u => { html += `<tr><td>${u.username}</td><td>${u.points}</td></tr>`; });
        html += "</table>";
        div.innerHTML = html;
      } else {
        div.innerHTML = "<p>No leaderboard data.</p>";
      }
    }
  </script>
</body>
</html>
