<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fogo Project</title>
    <style>
        :root {
            --bg-dark: #111827;
            --card-dark: #1f2937;
            --border-color: #374151;
            --text-light: #f9fafb;
            --text-muted: #9ca3af;
            --brand-blue: #2563eb;
            --brand-green: #16a34a;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 2rem 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .header-logo {
            max-width: 120px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        header h1 {
            font-size: 3rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            margin: 0;
        }

        .card {
            background-color: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }

        #login-screen { text-align: center; }
        #login-screen h2 { font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem; }
        #login-screen p { color: var(--text-muted); margin-bottom: 2rem; }

        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
        }

        .btn:hover { transform: scale(1.05); }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary { background-color: var(--brand-blue); color: white; }
        .btn-logout { background-color: #dc2626; color: white; padding: 0.5rem 1rem; }
        .btn-claim { background-color: var(--brand-green); color: white; }

        .profile-header { display: flex; justify-content: space-between; align-items: center; }
        .profile-header .points { font-size: 1.5rem; font-weight: bold; color: #4ade80; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
        @media (min-width: 1024px) { .dashboard-grid { grid-template-columns: 2fr 1fr; } }

        .section-title { font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem; }

        .task-item {
            background-color: rgba(55, 65, 81, 0.7);
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .task-item a { color: #60a5fa; text-decoration: none; }
        .task-item a:hover { text-decoration: underline; }
        
        .claimed-badge { background-color: var(--border-color); color: #4ade80; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: bold; }
        
        .leaderboard-table { width: 100%; text-align: left; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); }
        .leaderboard-table th { border-bottom-width: 2px; }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
        }
        .pagination-controls .page-info {
            font-weight: bold;
            color: var(--text-muted);
        }

        .footer { position: fixed; bottom: 1rem; left: 0; width: 100%; display: flex; justify-content: center; align-items: center; gap: 1.5rem; }
        .footer img { width: 40px; height: 40px; transition: transform 0.2s; }
        .footer img:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="fogo-logo.png" alt="Fogo Project Logo" class="header-logo">
            <h1>ðŸ”¥ Fogo Quest ðŸ”¥</h1>
        </header>

        <div id="login-screen" class="card">
            <h2>Welcome to the Fogo Quest Space</h2>
            <p>Please sign in with X to continue.</p>
            <a href="/auth/login" class="btn btn-primary">Sign in with X</a>
        </div>

        <div id="dashboard-screen" style="display: none;">
            <div class="profile-header card">
                <div>
                    <h2 id="profile-username" class="text-xl font-semibold"></h2>
                    <p id="profile-points" class="points"></p>
                </div>
                <button id="logout-button" class="btn btn-logout">Logout</button>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h3 class="section-title">Available Quests</h3>
                    <div id="tasks-container">
                        <p class="text-muted">Loading tasks...</p>
                    </div>
                </div>
                <div class="card">
                    <h3 class="section-title">Leaderboard</h3>
                    <div id="leaderboard-container">
                        <p class="text-muted">Loading leaderboard...</p>
                    </div>
                    
                    <div id="pagination-container" class="pagination-controls">
                        <button id="prev-button" class="btn">&lt; Previous</button>
                        <span id="page-info" class="page-info"></span>
                        <button id="next-button" class="btn">Next &gt;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <a href="https://discord.gg/your-server" target="_blank"><img src="discord-logo.png" alt="Discord"></a>
        <a href="https://your-linkedin-url" target="_blank"><img src="linkedin-logo.png" alt="LinkedIn"></a>
    </footer>

    <script>
        const API_BASE = "";
        let currentUser = null;

        let allLeaders = [];
        let currentPage = 1;
        const rowsPerPage = 10;

        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const profileUsername = document.getElementById('profile-username');
        const profilePoints = document.getElementById('profile-points');
        const logoutButton = document.getElementById('logout-button');
        const tasksContainer = document.getElementById('tasks-container');
        const leaderboardContainer = document.getElementById('leaderboard-container');
        
        const paginationContainer = document.getElementById('pagination-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const pageInfo = document.getElementById('page-info');

        async function initializeApp() {
            const params = new URLSearchParams(window.location.search);
            const userId = params.get('x_user_id');
            const username = params.get('username');
            if (userId && username) {
                localStorage.setItem('x_user_id', userId);
                localStorage.setItem('x_username', username);
                window.history.replaceState({}, '', window.location.pathname);
            }
            const storedUserId = localStorage.getItem('x_user_id');
            const storedUsername = localStorage.getItem('x_username');
            if (storedUserId && storedUsername) {
                currentUser = { userId: storedUserId, username: storedUsername };
                showDashboard();
                await loadDashboardData();
            } else {
                showLogin();
            }
        }
        
        async function loadDashboardData() {
            await Promise.all([
                fetchUserProfile(currentUser.userId), 
                fetchTasks(currentUser.userId), 
                fetchLeaderboard()
            ]);
        }
        
        async function fetchUserProfile(userId) {
            try {
                // UPDATED API PATH
                const response = await fetch(`${API_BASE}/api/fogo/me?x_user_id=${userId}`);
                const data = await response.json();
                if (data.user) {
                    profileUsername.innerText = `Welcome, ${currentUser.username}`;
                    profilePoints.innerText = `${data.user.points} Points`;
                }
            } catch (err) {
                console.error("Error fetching user profile:", err);
                profilePoints.innerText = 'Could not load points';
            }
        }

        async function fetchTasks(userId) {
            try {
                // UPDATED API PATH
                const tasks = await fetch(`${API_BASE}/api/fogo/tasks?x_user_id=${userId}`).then(r => r.json());
                renderTasks(tasks);
            } catch (err) {
                console.error("Error fetching tasks:", err);
                tasksContainer.innerHTML = '<p class="text-muted">Could not load tasks.</p>';
            }
        }

        function renderTasks(tasks) {
            tasksContainer.innerHTML = '';
            if (tasks.length === 0) {
                 tasksContainer.innerHTML = '<p class="text-muted">No tasks available right now.</p>';
                 return;
            }
            tasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = 'task-item';
                let actionHtml;
                if (task.claimed) {
                    actionHtml = `<span class="claimed-badge">âœ… Claimed</span>`;
                } else {
                    actionHtml = `<button class="btn btn-claim" data-task-id="${task.id}" data-points="${task.points}">Claim ${task.points} pts</button>`;
                }
                taskEl.innerHTML = `<div><p style="font-weight: bold;">${task.name}</p>${task.href ? `<a href="${task.href}" target="_blank">Go to Task ðŸ”—</a>` : ""}</div>${actionHtml}`;
                tasksContainer.appendChild(taskEl);
            });
        }
        
        async function fetchLeaderboard() {
            try {
                // UPDATED API PATH
                allLeaders = await fetch(`${API_BASE}/api/fogo/leaderboard`).then(r => r.json());
                currentPage = 1;
                renderLeaderboard();
            } catch (err) {
                console.error("Error fetching leaderboard:", err);
                leaderboardContainer.innerHTML = '<p class="text-muted">Could not load leaderboard.</p>';
                paginationContainer.style.display = 'none';
            }
        }
        
        function renderLeaderboard() {
            leaderboardContainer.innerHTML = '';
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedLeaders = allLeaders.slice(startIndex, endIndex);

            const table = document.createElement('table');
            table.className = 'leaderboard-table';
            let tableHtml = `<thead><tr><th>User</th><th style="text-align: right;">Points</th></tr></thead><tbody>`;
            paginatedLeaders.forEach(user => {
                tableHtml += `<tr><td>${user.username}</td><td style="text-align: right; color: #4ade80;">${user.points}</td></tr>`;
            });
            tableHtml += '</tbody>';
            table.innerHTML = tableHtml;
            leaderboardContainer.appendChild(table);

            updatePaginationControls();
        }
        
        function updatePaginationControls() {
            const totalPages = Math.ceil(allLeaders.length / rowsPerPage);
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            paginationContainer.style.display = 'flex';
            pageInfo.innerText = `Page ${currentPage} of ${totalPages}`;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        function showLogin() { loginScreen.style.display = 'block'; dashboardScreen.style.display = 'none'; }
        function showDashboard() { loginScreen.style.display = 'none'; dashboardScreen.style.display = 'block'; }

        function handleLogout() { localStorage.removeItem('x_user_id'); localStorage.removeItem('x_username'); currentUser = null; window.location.reload(); }

        async function handleClaimClick(event) {
            const claimButton = event.target.closest('.btn-claim');
            if (!claimButton) return;
            claimButton.disabled = true;
            claimButton.innerText = 'Claiming...';
            const taskId = claimButton.dataset.taskId;
            try {
                // UPDATED API PATH
                const response = await fetch(`${API_BASE}/api/fogo/claim`, { method: 'POST', headers: { "Content-Type": "application/json" }, body: JSON.stringify({ x_user_id: currentUser.userId, taskId: taskId }) });
                const data = await response.json();
                if (data.error) {
                    alert(data.error);
                    claimButton.disabled = false;
                    claimButton.innerText = `Claim ${claimButton.dataset.points} pts`;
                    return;
                }
                await fetchUserProfile(currentUser.userId);
                await fetchTasks(currentUser.userId);
            } catch (err) {
                console.error('Claim error:', err);
                alert('An error occurred while claiming the task.');
                claimButton.disabled = false;
                claimButton.innerText = `Claim ${claimButton.dataset.points} pts`;
            }
        }
        
        function handlePrevPage() { if (currentPage > 1) { currentPage--; renderLeaderboard(); } }
        function handleNextPage() { const totalPages = Math.ceil(allLeaders.length / rowsPerPage); if (currentPage < totalPages) { currentPage++; renderLeaderboard(); } }
        
        logoutButton.addEventListener('click', handleLogout);
        tasksContainer.addEventListener('click', handleClaimClick);
        prevButton.addEventListener('click', handlePrevPage);
        nextButton.addEventListener('click', handleNextPage);
        
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>